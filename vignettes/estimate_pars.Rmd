---
title: "Estimating aphid population parameters"
author: "Lucas A. Nell"
date: "2018-07-03"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimating aphid population parameters}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svglite"
)
knitr::opts_knit$set(root.dir = normalizePath(".."))
# source(".Rprofile")
bayesplot::color_scheme_set("viridis")
```

```{r library_pkgs, warning=FALSE}
suppressPackageStartupMessages({
    library(aphidreps)
})
```

## Load data

```{r load_data}
growth <- load_data()
growth
```

## Convert data

```{r convert_data}
model_data <- growth %>% 
    line_data()
```


## Run model

```{r run_model, eval = FALSE}
stan_fit <- model_data %>% 
    fit_lines(plants = TRUE)
```


## Examine model output

```{r examine_model, eval = FALSE}
apply(rstan::extract(stan_fit, "R0", permuted = FALSE), 3, mean)
apply(rstan::extract(stan_fit, "alpha", permuted = FALSE), 3, mean)
apply(rstan::extract(stan_fit, "process", permuted = FALSE), 3, mean)

print(stan_fit, digits = 6, pars = c("R0", "alpha", "beta", "process"), probs = c())


pred_df <- make_pred_df(stan_fit, growth)

pred_df %>% 
    ggplot(aes(date, X)) +
    geom_ribbon(aes(ymin = X_lower, ymax = X_upper),
                fill = "gray70", alpha = 0.5) +
    geom_line(color = "gray60") +
    geom_point(shape = 1, color = "gray60") +
    geom_line(aes(y = X_pred), color = "dodgerblue3", size = 0.5) +
    facet_wrap(~ rep + line, nrow = 5) +
    NULL



```


