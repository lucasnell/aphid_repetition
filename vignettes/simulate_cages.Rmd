---
title: "Simulate cages"
author: "Lucas A. Nell"
date: "2018-07-03"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Simulate cages}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svglite", 
  fig.width = 6,
  fig.height = 4
)
knitr::opts_knit$set(root.dir = normalizePath(".."))
options(tibble.print_min = 4L, tibble.print_max = 4L)
```
```{r source_Rprofile, echo = FALSE}
source(".Rprofile")
```

```{r library_pkgs, warning=FALSE}
suppressPackageStartupMessages({
    library(clonewars)
})
```


## Load dataset

```{r load_growth_dataset}
growth <- load_data()
```


## Load stan fit data

```{r load_stan_fit_data}
stan_fit <- read_rds("data-raw/stan_fit.rds")
```



```{r}
n_plants <- 16
n_lines <- 8-1  # WI-L4Ø had all its reps filtered out, more are on the way
X_0 <- matrix(rep(log(50), n_lines * n_plants), n_plants, n_lines)
max_t <- 180
R <- apply(rstan::extract(stan_fit, "R", permuted = FALSE), 3, mean) %>%
    as.numeric()
A <- apply(rstan::extract(stan_fit, "A", permuted = FALSE), 3, mean) %>%
    as.numeric()
D_slope <- disp_estimates$slope[disp_estimates$line != "WI-L4Ø"]
D_inter <- disp_estimates$inter[disp_estimates$line != "WI-L4Ø"]
process_error <- apply(rstan::extract(stan_fit, "s_epsilon", permuted = FALSE), 3, mean) %>%
    as.numeric()
plant_mort_coefs <- clonewars::plant_death$after_max_mort_coefs
plant_death_age <- clonewars::plant_death$days_to_max
repl_every <- 4
plants_per <- 4  # plants to replace per replacement day
plant_repl <- data_frame(date = seq(repl_every, max_t, repl_every)) %>%
    mutate(plant = case_when(
        (date / repl_every) %% 4 == 1 ~ list(1:plants_per),
        (date / repl_every) %% 4 == 2 ~ list((plants_per + 1):(2 * plants_per)),
        (date / repl_every) %% 4 == 3 ~ list((2 * plants_per + 1):(3 * plants_per)),
        (date / repl_every) %% 4 == 0 ~ list((3 * plants_per + 1):n_plants),
        TRUE ~ list(NA)
        )) %>%
    unnest()
# plant_repl <- data_frame(date = 2000, plant = 1)
n_reps <- 10
n_chains <- 1
```




```{r do_sims}
set.seed(654651984L)
sim_df <- sim_cages(X_0, max_t, R, A, D_slope, D_inter, process_error,
                    plant_mort_coefs, plant_death_age, plant_repl,
                    n_reps) %>% 
    mutate(N = exp(X)) %>%
    identity()

sim_by_cage <- sim_df %>% 
    mutate(line = factor(line,
                         levels = seq_along(levels(growth$line)),
                         labels = levels(growth$line)),
           rep = factor(rep)) %>% 
    group_by(rep, line, date) %>% 
    summarize(X = N %>% sum() %>% log()) %>%
    ungroup()
```


```{r plot_sims}
sim_df %>% 
    filter(rep == 1, date < 60) %>% 
    ggplot(aes(date, X)) +
    geom_line(aes(color = factor(line))) +
    facet_wrap(~ factor(plant)) +
    scale_color_brewer(palette = "Dark2") +
    NULL

sim_by_cage %>% 
    mutate(N = exp(X)) %>% 
    ggplot(aes(date, N)) +
    # ggplot(aes(date, X)) +
    geom_line(aes(color = line)) +
    facet_wrap(~ rep) +
    scale_color_brewer("Aphid line:", palette = "Dark2", guide = guide_legend(ncol = 2)) +
    theme(legend.position = c(1, 0), legend.justification = c(1, 0)) +
    # coord_cartesian(ylim = c(0, 10)) +
    NULL


```

