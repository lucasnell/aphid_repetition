---
title: "Choose priors"
author: "Lucas A. Nell"
date: "2018-07-04"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Choose priors}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dev = "svglite", 
  fig.width = 6,
  fig.height = 4
)
knitr::opts_knit$set(root.dir = normalizePath(".."))
# source(".Rprofile")
bayesplot::color_scheme_set("viridis")
```


```{r library_pkgs, warning=FALSE, echo=FALSE}
suppressPackageStartupMessages({
    library(clonewars)
})
```


## Model

Below is the model I'm fitting:

$$
X_{t+1} = X_t + r \left( 1 - \alpha ~ \text{e}^{X_t} \right) + \varepsilon
$$

where $X_t$ is log aphid counts for a particular plant at time $t$,
$r$ is the aphid line's growth rate,
$\alpha$ is the line's density dependence,
and
$\varepsilon$ is process error.



### Estimating process error

$\sigma_\varepsilon$ is bound $\ge 0$ and sampled as $\sim \text{Half-Cauchy}(w_0, \eta)$.


### Estimating growth rates 

Growth rates are bound $\ge 0$ and have one estimate per aphid line,
resulting in a vector of growth rates, $\mathbf{R}$.
The growth rate estimate for clonal line $i$ ($r = \mathbf{R}_i$) is generated
as follows:

$$
\begin{align}
    
    \mathbf{R}_i &= \exp \left( \theta + s_\theta ~ \mathbf{Z_{(\theta)}}_{i} \right) \\
    
    \theta &\sim \text{N}(\mu_{\theta}, \sigma^{2}_{\theta}) \\
    s_\theta &\sim \text{Half-Cauchy}(x_0, \gamma) \\
    \mathbf{Z_{(\theta)}} &\sim \text{N}(0,1) \\
    
\end{align}
$$


#### Estimated from model:

- $\mathbf{R}$: vector of growth rates for each aphid line
- $\theta$: among-line mean of the log-transformed growth rates
- $s_\theta$: among-line standard deviation of the log-transformed growth rates


#### Priors to define:

- $\mu_\theta$: mean of the normal distribution that generates $\theta$ values
- $\sigma^{2}_\theta$: variance of the normal distribution that generates $\theta$ values
- $x_0$: location parameter for the half-Cauchy distribution that generates
  $s_\theta$ values
- $\gamma$: scale parameter for the half-Cauchy distribution that generates
  $s_\theta$ values


#### Temporary objects:

- $\mathbf{Z_{(\theta)}}$: a vector of the same length as the number of aphid lines,
  containing z-scores to generate variability in growth rates among aphid clones.


### Estimating density dependence

Density dependences are bound between 0 and 1 and also have estimates for each line.
They differ from $r$ in that they also have variance within aphid lines, to account
for effects of variability in plant resources affecting aphid density dependence.
I used the inverse logit function to bound final $\alpha$ estimates between 0 and 1.
For clonal line $i$ and plant $j$, estimates are generated as follows:

$$
\begin{align}

    \mathbf{A}_i &= \text{logit}^{-1} \hspace{-0.25em}
        \left(
            \phi + s_\phi ~ \mathbf{Z_{(\phi)}}_i
        \right) \\
    
    \mathbf{P}_{j} &= \text{logit}^{-1} \hspace{-0.25em}
        \left(
            \phi + s_\phi ~ \mathbf{Z_{(\phi)}}_{\mathbf{L}_j} + 
            \mathbf{S}_{\mathbf{L}_j} ~ \mathbf{Z_{(A)}}_{j}
        \right) \\
    
    \phi &\sim N(\mu_{\phi}, \sigma^{2}_{\phi}) \\
    s_{\phi} &\sim \text{Half-Cauchy}(y_0, \delta) \\
    \mathbf{S} &\sim \text{Half-Cauchy}(z_0, \zeta) \\
    
    \mathbf{Z_{(\phi)}} &\sim N(0,1) \\
    \mathbf{Z_{(A)}} &\sim N(0,1) \\
\end{align}
$$



#### Estimated from model:

- $\mathbf{A}$: vector of density dependences for each aphid line
- $\mathbf{P}$: vector of density dependences for each plant (i.e., time series)
- $\phi$: among-line mean of the logit-transformed density dependences
- $s_\phi$: among-line standard deviation of the logit-transformed density dependences
- $\mathbf{S}$: vector of the within-line standard deviations in the
    logit-transformed density dependences for each aphid line


#### Priors to define:

- $\mu_\phi$: mean of the normal distribution that generates $\phi$ values
- $\sigma^{2}_\phi$: variance of the normal distribution that generates $\phi$ values
- $y_0$: location parameter for the half-Cauchy distribution that generates
  $s_\phi$ values
- $\delta$: scale parameter for the half-Cauchy distribution that generates
  $s_\phi$ values
- $z_0$: location parameter for the half-Cauchy distribution that generates
  values in $\mathbf{S}$
- $\zeta$: scale parameter for the half-Cauchy distribution that generates
  values in $\mathbf{S}$


#### Other:

- $\mathbf{L}_j$ is an identifier vector that returns the index to the aphid line
  for time series $j$.
- $\mathbf{Z_{(\phi)}}$: a vector of the same length as the number of aphid lines,
  containing z-scores to generate variability in density dependences among aphid clones.
- $\mathbf{Z_{(A)}}$: a vector of the same length as the number of time series,
  containing z-scores to generate variability in density dependences within aphid clones.




<!---
********************************************************************************
********************************************************************************
********************************************************************************
********************************************************************************

BELOW HERE HAS NOT BEEN UPDATED FOR NEW STRUCTURING OF ALPHA AND R

********************************************************************************
********************************************************************************
********************************************************************************
********************************************************************************
-->




## Growth rates

From data sent to me from A.R. Ives related to this paper:

Meisner, M. H., J. P. Harmon, and A. R. Ives. 2014. Temperature effects on
long-term population dynamics in a parasitoid–host system.
*Ecological Monographs* __84__:457–476.

For fecundity, juvenile survival, and adult survival, the dataset had low and high
estimates.
I created two Leslie matrices, one with all of the high estimates and another
with all the lower estimates.
For each of these Leslie matrices, I estimated the intrinsic daily rate of increase
($r$) in aphid populations in the lab as $r = \log(\lambda)$, where $\lambda$ is the
dominant eigenvector of the matrix.
Thus I have fast and slow estimates of population growth, and from these I estimated
the mean and standard deviation of the population-growth parameter.
If the clonal lines from Meisner et al. (2014) are representative of the lines
we currently have, and if these Leslie matrices truly represent the edges of possible
$r$ values, then this standard deviation should be an upper estimate.
The SE of $r$ is what I'll use for the standard deviation of the mean.


```{r load_leslies}
fast <- read_csv("data-raw/leslie_fast.csv", col_names = FALSE,
                 col_types = cols(.default = col_double())) %>% 
    as.matrix() %>% 
    eigen() %>% 
    .[["values"]] %>% 
    .[1] %>% 
    Re() %>% 
    log()
slow <- read_csv("data-raw/leslie_slow.csv", col_names = FALSE,
                 col_types = cols(.default = col_double())) %>% 
    as.matrix() %>% 
    eigen() %>% 
    .[["values"]] %>% 
    .[1] %>% 
    Re() %>% 
    log()
fast; slow
mean(c(fast, slow)); sd(c(fast, slow))
sd(c(fast, slow)) / sqrt(2)
```


The cauchy distribution with scale = 0.005 seems about right for sampling the
among-line SD.

```{r R0_sd_plot}
compare_priors(sd(c(fast, slow)) / sqrt(2), 0.005, xlim = c(0, 0.05)) +
    geom_vline(xintercept = sd(c(fast, slow)) / sqrt(2))
```


## Density dependence

### Among-line distribution

Because Meisner et al. (2014) used cages of 8 plants, I'm setting my desired mean
for $\alpha$ by multiplying their density-dependence estimate ($0.000467$) by 8:
$\bar\alpha = 0.000467 \times 8 = 0.003736$.

They parameterized their density dependence slightly differently from the model I'm
using, so I'm setting the standard deviation for $\alpha$ to be fairly wide.
So for the distribution of mean alpha among all lines, the beta curve below looks
good to me.
The beta distribution is particularly nice because it's bound between 0 and 1, just
like any reasonable $\alpha$ estimate should be.


```{r alpha_overall_mean_plot}
compare_priors(0.003736, 0.0015, xlim = c(0, 0.01), beta = TRUE) +
    geom_vline(xintercept = 0.003736)
```


For sampling mean alphas for each line, I'm going to increase the SD to 
0.002 to allow for a greater possibility of more extreme values for each line.

```{r alpha_line_means_plot}
compare_priors(0.003736, 0.002, xlim = c(0, 0.01), beta = TRUE) +
    geom_vline(xintercept = 0.003736)
```


For the among-line SD distribution, I used a cauchy distribution with location = 0.0015
and scale = 0.0005 because it looks most reasonable to me.

```{r alpha_among_line_sd_plot}
compare_priors(0.0015, 0.0005, xlim = c(0, 0.005)) +
    geom_vline(xintercept = 0.0015)
```


### Within-line distribution

I'm really not sure about the degree to which different plants will affect the
density dependence within an aphid line.
I'll use some raw data from Meisner et al. (2014) to get some idea.
Below is from their cage experiments when they added parasitoid wasps after aphid
densities were allowed to peak (35 days).
I didn't use these estimates for mean alpha because of the potential effect of wasps,
but this is probably as good an estimate of variance among plants that I'll get.
Notice that I'm dividing the max number of aphids by 8 because there were 8 plants
in this experiment.


```{r Meisner_cage_data}
read_csv("data-raw/MeisnerLongtermCageData.csv",
         col_types = "iiiiii") %>% 
    filter(treatment == 0, year == 2009) %>% 
    group_by(replicate) %>% 
    summarize(alpha = 1 / max(aphids / 8)) %>% 
    select(alpha) %>% 
    summarize(sd = sd(alpha)) %>% 
    unlist() %>% 
    signif(3)
```


I'm choosing a cauchy distribution with location of 0.00142 and scale of 0.02 
because I'm pretty uncertain of this parameter.

```{r alpha_within_line_sd_plot}
compare_priors(0.00142, 0.02, xlim = c(0, 0.1)) +
    geom_vline(xintercept = 0.00142)
```



## Process error

I'm not really sure what this should be, but based on simulations, a value of 1 would
be very high.
Thus I chose a cauchy distribution with 0.1 as the location and scale because
this appears about right.

```{r process_error_plot}
compare_priors(0.1, 0.1, xlim = c(0, 1)) +
    geom_vline(xintercept = 0.1)
```

